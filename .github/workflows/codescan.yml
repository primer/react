name: 'Code Scan'

on:
  push:
  schedule:
    - cron: '0 0 * * *'

jobs:
  codescan:
    name: Scan the repository
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm i -g npm@^10.5.1
      - name: Install dependencies
        run: npm ci

      - uses: actions/github-script@v7
        id: file-counts
        with:
          script: |
            const fg = require('fast-glob')
            const fs = require('fs')
            const files = await fg.glob('packages/react/src/**/*.tsx', {
              ignore: [
                '**/__tests__/**',
                '**/_*.tsx',
                '**/*.figma.tsx',
                '**/*.stories.tsx',
                '**/*.test.tsx',
                '**/hooks/**',
                '**/index.tsx',
                '**/utils/**',
              ],
            })

            const metrics = []

            for (const file of files) {
              const content = fs.readFileSync(file, 'utf8')
              const matched = content.match(/.`$([^`]*)^`$/gm)
              if (matched) {
                const count = matched.join('\n').split('\n').length
                metrics.push(
                  `- type: "count"\n  name: "primer.react.styled-system.count"\n  value: ${count}\n  tags:\n    - "path:${file}"`,
                )
              }
            }

            core.setOutput('metrics', metrics.join('\n'))

      - run: echo "${{ steps.file-counts.outputs.metrics }}"
